# 数据库部署指南

## 方案选择：Vercel + Vercel Postgres

根据测试结果，我们选择 Vercel 作为后端服务器，原因：
- ✅ 完全免费（Hobby 计划）
- ✅ 中国可访问，不需要魔法
- ✅ 配置简单，一键部署
- ✅ 自动 HTTPS 和全球 CDN
- ✅ 有完整的管理后台

## 部署步骤

### 第一步：部署后端 API

#### Windows 用户

1. 打开命令提示符（CMD）
2. 进入后端目录：
   ```bash
   cd personality_quiz_app\backend\vercel
   ```
3. 运行部署脚本：
   ```bash
   deploy.bat
   ```

#### Mac/Linux 用户

1. 打开终端
2. 进入后端目录：
   ```bash
   cd personality_quiz_app/backend/vercel
   ```
3. 添加执行权限并运行：
   ```bash
   chmod +x deploy.sh
   ./deploy.sh
   ```

#### 手动部署（如果脚本失败）

```bash
# 1. 安装 Vercel CLI
npm install -g vercel

# 2. 登录 Vercel
vercel login

# 3. 部署
vercel --prod
```

部署过程中会询问：
- **项目名称**：输入 `quiz-api` 或其他名称
- **是否链接到现有项目**：选择 `N`（新项目）

部署成功后，会得到一个地址，例如：
```
https://quiz-api-xxx.vercel.app
```

**保存这个地址，后面会用到！**

### 第二步：创建数据库

1. 访问 [Vercel Dashboard](https://vercel.com/dashboard)
2. 进入你刚才部署的项目（quiz-api）
3. 点击顶部的 **"Storage"** 标签
4. 点击 **"Create Database"** 按钮
5. 选择 **"Postgres"**
6. 输入数据库名称（例如：quiz_db）
7. 选择区域（建议选择离中国近的，如 Singapore）
8. 点击 **"Create"** 创建数据库

### 第三步：初始化数据库表

1. 在 Vercel Dashboard 中，进入你的 Postgres 数据库
2. 点击 **"Query"** 标签
3. 复制以下 SQL 并执行：

```sql
CREATE TABLE IF NOT EXISTS reports (
    id SERIAL PRIMARY KEY,
    share_code VARCHAR(10) NOT NULL UNIQUE,
    quiz_type_id VARCHAR(50) NOT NULL,
    quiz_type_name VARCHAR(100) NOT NULL,
    report_data JSONB NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP,
    last_viewed_at TIMESTAMP,
    view_count INTEGER DEFAULT 0,
    ip_address VARCHAR(45),
    CONSTRAINT idx_share_code UNIQUE (share_code)
);

CREATE INDEX idx_quiz_type ON reports(quiz_type_id);
CREATE INDEX idx_created_at ON reports(created_at);
```

4. 点击 **"Run Query"** 执行

### 第四步：配置 Flutter 应用

1. 打开文件：`personality_quiz_app/lib/core/services/database_service.dart`

2. 找到这一行：
   ```dart
   static const String _apiBaseUrl = 'YOUR_VERCEL_API_URL';
   ```

3. 替换为你的 Vercel API 地址（第一步得到的地址）：
   ```dart
   static const String _apiBaseUrl = 'https://quiz-api-xxx.vercel.app';
   ```

4. 保存文件

### 第五步：重新构建并部署 Flutter 应用

```bash
# 进入项目目录
cd personality_quiz_app

# 构建 Web 版本
flutter build web --release

# 部署到 Netlify（如果使用 Netlify）
# 将 build/web 目录的内容上传到 Netlify
```

## 功能说明

### 自动上传

用户完成测试后，测试结果会自动上传到数据库，无需任何操作。

### 管理后台

访问应用中的管理后台页面（需要在应用中添加入口），可以：
- 查看所有测试数据
- 按测试类型筛选
- 查看统计数据（总数、今日新增、本周新增、总浏览）
- 查看单个报告详情
- 删除报告
- 复制分享码

### 分享功能

用户可以通过分享码分享测试结果，其他人输入分享码即可查看。

## API 端点

部署完成后，你的 API 端点：

- **保存报告**：`POST /api/reports`
- **获取报告**：`GET /api/reports?shareCode=ABC123`
- **获取列表**：`GET /api/reports?page=1&limit=20`
- **统计数据**：`GET /api/stats`
- **删除报告**：`DELETE /api/reports?shareCode=ABC123`

## 测试 API

部署完成后，可以使用以下命令测试 API 是否正常：

```bash
# 测试统计接口
curl https://quiz-api-xxx.vercel.app/api/stats

# 应该返回类似这样的数据：
# {"success":true,"data":{"totalReports":0,"todayReports":0,"weekReports":0,"totalViews":0,"byType":[]}}
```

## 常见问题

### Q: 部署失败怎么办？

A: 检查以下几点：
1. 是否安装了 Node.js（https://nodejs.org/）
2. 是否成功登录 Vercel（运行 `vercel login`）
3. 查看错误信息，通常会提示具体问题

### Q: 数据库连接失败？

A: 确保：
1. 已经在 Vercel Dashboard 中创建了 Postgres 数据库
2. 数据库和 API 在同一个项目下
3. Vercel 会自动注入环境变量，无需手动配置

### Q: API 返回 404？

A: 检查：
1. API 文件是否在 `api/` 目录下
2. 部署是否成功（查看 Vercel Dashboard 的部署日志）
3. URL 是否正确（应该是 `/api/reports` 而不是 `/reports`）

### Q: CORS 错误？

A: 已在 `vercel.json` 中配置了 CORS，如果仍有问题：
1. 检查浏览器控制台的具体错误信息
2. 确认 `vercel.json` 文件存在且配置正确

### Q: 免费版有什么限制？

A: Vercel Hobby 计划限制：
- 数据库：256 MB 存储
- 带宽：每月 100 GB
- 对于测试应用来说完全够用

### Q: 如何查看数据库中的数据？

A: 两种方式：
1. 在 Vercel Dashboard 的 Postgres 数据库中使用 Query 功能
2. 在 Flutter 应用中使用管理后台页面

## 下一步

部署完成后，你可以：
1. 在应用中添加管理后台入口（例如在设置页面）
2. 测试上传和下载功能
3. 查看统计数据
4. 根据需要调整 API 功能

## 备选方案

如果 Vercel 不满足需求，可以考虑：
1. **Render**（免费但慢）
2. **阿里云/腾讯云**（最快但需要付费和配置）
3. **Supabase**（免费，功能强大，但可能需要魔法）

## 技术支持

如有问题，可以：
1. 查看 Vercel 官方文档：https://vercel.com/docs
2. 查看 Vercel Postgres 文档：https://vercel.com/docs/storage/vercel-postgres
3. 查看项目中的 `backend/vercel/README.md`
