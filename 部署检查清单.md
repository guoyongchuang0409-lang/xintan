# 部署检查清单 ✅

使用这个清单确保所有步骤都已完成。

## 📋 准备工作

- [ ] 已安装 Node.js（https://nodejs.org/）
- [ ] 已注册 Vercel 账号（https://vercel.com/）
- [ ] 已安装 Flutter SDK
- [ ] 已有 Netlify 账号（用于部署前端）

## 🚀 后端部署

### 步骤 1：部署 API 到 Vercel

- [ ] 打开终端/命令提示符
- [ ] 进入目录：`cd personality_quiz_app/backend/vercel`
- [ ] 运行部署脚本：
  - Windows: `deploy.bat`
  - Mac/Linux: `./deploy.sh`
- [ ] 登录 Vercel 账号
- [ ] 等待部署完成
- [ ] 记录 API 地址（例如：https://quiz-api-xxx.vercel.app）

**API 地址**：_____________________________________

### 步骤 2：创建数据库

- [ ] 访问 https://vercel.com/dashboard
- [ ] 进入你的项目（quiz-api）
- [ ] 点击 "Storage" 标签
- [ ] 点击 "Create Database"
- [ ] 选择 "Postgres"
- [ ] 输入数据库名称（例如：quiz_db）
- [ ] 选择区域（建议：Singapore）
- [ ] 点击 "Create" 创建

### 步骤 3：初始化数据库

- [ ] 在 Vercel Dashboard 中，进入 Postgres 数据库
- [ ] 点击 "Query" 标签
- [ ] 复制并执行以下 SQL：

```sql
CREATE TABLE IF NOT EXISTS reports (
    id SERIAL PRIMARY KEY,
    share_code VARCHAR(10) NOT NULL UNIQUE,
    quiz_type_id VARCHAR(50) NOT NULL,
    quiz_type_name VARCHAR(100) NOT NULL,
    report_data JSONB NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP,
    last_viewed_at TIMESTAMP,
    view_count INTEGER DEFAULT 0,
    ip_address VARCHAR(45),
    CONSTRAINT idx_share_code UNIQUE (share_code)
);

CREATE INDEX idx_quiz_type ON reports(quiz_type_id);
CREATE INDEX idx_created_at ON reports(created_at);
```

- [ ] 点击 "Run Query" 执行
- [ ] 确认表创建成功

## 📱 Flutter 应用配置

### 步骤 4：配置 API 地址

- [ ] 打开文件：`lib/core/services/database_service.dart`
- [ ] 找到这一行：
  ```dart
  static const String _apiBaseUrl = 'YOUR_VERCEL_API_URL';
  ```
- [ ] 替换为你的 API 地址：
  ```dart
  static const String _apiBaseUrl = 'https://quiz-api-xxx.vercel.app';
  ```
- [ ] 保存文件

### 步骤 5：重新构建应用

- [ ] 打开终端
- [ ] 进入项目目录：`cd personality_quiz_app`
- [ ] 运行构建命令：`flutter build web --release`
- [ ] 等待构建完成
- [ ] 确认 `build/web` 目录已生成

### 步骤 6：部署到 Netlify

- [ ] 访问 https://app.netlify.com/
- [ ] 进入你的网站（xintan.netlify.app）
- [ ] 点击 "Deploys" 标签
- [ ] 拖拽 `build/web` 目录到上传区域
- [ ] 等待部署完成
- [ ] 访问你的网站确认更新

## 🧪 功能测试

### 步骤 7：测试 API

- [ ] 在浏览器中访问：`https://quiz-api-xxx.vercel.app/api/stats`
- [ ] 应该看到 JSON 响应：
  ```json
  {
    "success": true,
    "data": {
      "totalReports": 0,
      "todayReports": 0,
      "weekReports": 0,
      "totalViews": 0,
      "byType": []
    }
  }
  ```

### 步骤 8：测试自动上传

- [ ] 访问你的应用：https://xintan.netlify.app
- [ ] 完成一次测试
- [ ] 打开浏览器控制台（F12）
- [ ] 查看 Console 标签
- [ ] 应该看到上传日志：
  ```
  🚀 [自动上传] 开始上传测试结果...
  ✅ [自动上传] 上传成功！
  ```

### 步骤 9：测试管理后台

- [ ] 在应用中添加管理后台入口（见下方代码）
- [ ] 访问管理后台页面
- [ ] 应该能看到刚才上传的测试数据
- [ ] 测试以下功能：
  - [ ] 查看统计数据
  - [ ] 查看报告列表
  - [ ] 按类型筛选
  - [ ] 查看报告详情
  - [ ] 复制分享码
  - [ ] 删除报告（可选）

### 步骤 10：测试分享功能

- [ ] 记录一个分享码
- [ ] 在应用中输入分享码
- [ ] 应该能看到对应的测试结果

## 🔧 添加管理后台入口

在你的应用中添加管理后台入口，例如在设置页面或首页：

```dart
import 'package:flutter/material.dart';
import '../pages/admin_page.dart';

// 在你的页面中添加：
ElevatedButton(
  onPressed: () {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const AdminPage(),
      ),
    );
  },
  child: const Text('管理后台'),
)
```

或者添加一个隐藏的入口（例如长按某个按钮）：

```dart
GestureDetector(
  onLongPress: () {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const AdminPage(),
      ),
    );
  },
  child: Icon(Icons.settings),
)
```

## 📊 可选：添加测试页面

如果需要调试，可以添加测试页面入口：

```dart
import '../pages/database_test_page.dart';

// 添加按钮：
ElevatedButton(
  onPressed: () {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const DatabaseTestPage(),
      ),
    );
  },
  child: const Text('数据库测试'),
)
```

## ✅ 完成确认

全部完成后，你的应用应该具备以下功能：

- ✅ 用户完成测试后自动上传到数据库
- ✅ 生成唯一的分享码
- ✅ 可以通过分享码查看测试结果
- ✅ 管理员可以查看所有测试数据
- ✅ 管理员可以查看统计数据
- ✅ 管理员可以筛选、查看、删除报告
- ✅ 中国用户可以正常访问，不需要魔法

## 🎉 恭喜！

如果所有步骤都已完成并打勾，那么你已经成功实现了完整的数据库功能！

## 📚 相关文档

- [数据库部署指南.md](./数据库部署指南.md) - 详细部署步骤
- [快速开始 - 数据库功能.md](./快速开始%20-%20数据库功能.md) - 快速开始
- [数据库功能实现总结.md](./数据库功能实现总结.md) - 功能总结
- [backend/vercel/README.md](./backend/vercel/README.md) - 后端说明

## 🆘 遇到问题？

如果遇到问题，请检查：

1. **API 返回 404**
   - 确认 API 已成功部署到 Vercel
   - 确认 URL 正确（应该是 `/api/reports` 而不是 `/reports`）

2. **数据库连接失败**
   - 确认已在 Vercel Dashboard 创建了 Postgres 数据库
   - 确认数据库和 API 在同一个项目下

3. **上传失败**
   - 检查浏览器控制台的错误信息
   - 确认 `database_service.dart` 中的 API 地址配置正确
   - 测试 API 是否正常（访问 `/api/stats`）

4. **管理后台显示"数据库未配置"**
   - 确认 `database_service.dart` 中的 `_apiBaseUrl` 已正确配置
   - 确认不是 `'YOUR_VERCEL_API_URL'`

## 📞 技术支持

- Vercel 文档：https://vercel.com/docs
- Vercel Postgres 文档：https://vercel.com/docs/storage/vercel-postgres
- Flutter 文档：https://flutter.dev/docs

---

**最后更新**：2024-02-28
