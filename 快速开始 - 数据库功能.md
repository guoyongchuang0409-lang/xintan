# 快速开始 - 数据库功能

## 🎯 目标

实现测试结果的上传、下载、查询功能，用户不需要魔法（VPN）。

## ✅ 已完成的工作

1. ✅ 创建了 Vercel 后端 API（Serverless 函数）
2. ✅ 创建了 Flutter 数据库服务
3. ✅ 创建了管理后台页面
4. ✅ 更新了自动上传功能
5. ✅ 创建了部署脚本和文档

## 🚀 快速部署（5 分钟）

### 步骤 1：部署后端到 Vercel

**Windows 用户：**
```bash
cd personality_quiz_app\backend\vercel
deploy.bat
```

**Mac/Linux 用户：**
```bash
cd personality_quiz_app/backend/vercel
chmod +x deploy.sh
./deploy.sh
```

按照提示操作，部署成功后会得到一个地址，例如：
```
https://quiz-api-xxx.vercel.app
```

**保存这个地址！**

### 步骤 2：创建数据库

1. 访问 https://vercel.com/dashboard
2. 进入你的项目（quiz-api）
3. 点击 "Storage" → "Create Database" → "Postgres"
4. 创建数据库

### 步骤 3：初始化数据库

在 Vercel Dashboard 的数据库 Query 界面执行：

```sql
CREATE TABLE IF NOT EXISTS reports (
    id SERIAL PRIMARY KEY,
    share_code VARCHAR(10) NOT NULL UNIQUE,
    quiz_type_id VARCHAR(50) NOT NULL,
    quiz_type_name VARCHAR(100) NOT NULL,
    report_data JSONB NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP,
    last_viewed_at TIMESTAMP,
    view_count INTEGER DEFAULT 0,
    ip_address VARCHAR(45),
    CONSTRAINT idx_share_code UNIQUE (share_code)
);

CREATE INDEX idx_quiz_type ON reports(quiz_type_id);
CREATE INDEX idx_created_at ON reports(created_at);
```

### 步骤 4：配置 Flutter 应用

打开 `lib/core/services/database_service.dart`，修改：

```dart
// 修改前：
static const String _apiBaseUrl = 'YOUR_VERCEL_API_URL';

// 修改后（替换为你的地址）：
static const String _apiBaseUrl = 'https://quiz-api-xxx.vercel.app';
```

### 步骤 5：重新构建应用

```bash
cd personality_quiz_app
flutter build web --release
```

然后将 `build/web` 目录上传到 Netlify。

## 🎉 完成！

现在你的应用已经具备以下功能：

### 用户端功能

- ✅ 完成测试后自动上传到数据库（静默上传，无提示）
- ✅ 生成唯一的分享码
- ✅ 可以通过分享码查看测试结果

### 管理员功能

访问管理后台页面（需要在应用中添加入口），可以：
- ✅ 查看所有测试数据
- ✅ 按测试类型筛选
- ✅ 查看统计数据（总数、今日新增、本周新增、总浏览）
- ✅ 查看单个报告详情
- ✅ 删除报告
- ✅ 复制分享码

## 📱 如何添加管理后台入口

在你的应用中添加一个按钮或菜单项，导航到管理后台：

```dart
// 例如在设置页面或首页添加：
ElevatedButton(
  onPressed: () {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => const AdminPage(),
      ),
    );
  },
  child: const Text('管理后台'),
)
```

## 🧪 测试功能

### 测试自动上传

1. 完成一次测试
2. 查看控制台日志，应该看到：
   ```
   🚀 [自动上传] 开始上传测试结果...
   ✅ [自动上传] 上传成功！
   ```

### 测试管理后台

1. 访问管理后台页面
2. 应该能看到刚才上传的测试数据
3. 尝试查看、复制、删除功能

### 测试 API

在浏览器中访问：
```
https://quiz-api-xxx.vercel.app/api/stats
```

应该返回统计数据：
```json
{
  "success": true,
  "data": {
    "totalReports": 1,
    "todayReports": 1,
    "weekReports": 1,
    "totalViews": 0,
    "byType": [...]
  }
}
```

## 📊 API 端点

你的 API 提供以下端点：

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/reports` | POST | 保存报告 |
| `/api/reports?shareCode=XXX` | GET | 获取单个报告 |
| `/api/reports?page=1&limit=20` | GET | 获取报告列表 |
| `/api/stats` | GET | 获取统计数据 |
| `/api/reports?shareCode=XXX` | DELETE | 删除报告 |

## 🔧 故障排查

### 问题：API 返回 "API 地址未配置"

**解决**：检查 `database_service.dart` 中的 `_apiBaseUrl` 是否已正确配置。

### 问题：上传失败

**解决**：
1. 检查网络连接
2. 查看控制台日志的详细错误信息
3. 确认 Vercel API 是否正常运行（访问 `/api/stats` 测试）

### 问题：管理后台显示 "数据库未配置"

**解决**：同上，检查 `_apiBaseUrl` 配置。

### 问题：数据库连接失败

**解决**：
1. 确认已在 Vercel Dashboard 创建了 Postgres 数据库
2. 确认数据库和 API 在同一个项目下
3. Vercel 会自动注入环境变量，无需手动配置

## 📚 更多信息

- 详细部署指南：`数据库部署指南.md`
- Vercel 后端说明：`backend/vercel/README.md`
- 服务器测试结果：`服务器访问测试结果.txt`

## 💡 提示

- 免费版 Vercel 提供 256 MB 数据库存储，对于测试应用完全够用
- 数据会永久保存，除非手动删除
- API 自动支持 HTTPS 和全球 CDN
- 中国用户可以正常访问，不需要魔法

## 🎊 恭喜！

你已经成功实现了完整的数据库功能！用户现在可以：
- 自动上传测试结果
- 通过分享码分享结果
- 你可以在管理后台查看所有数据

享受你的应用吧！ 🚀
